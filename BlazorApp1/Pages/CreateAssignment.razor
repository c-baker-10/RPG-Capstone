@page "/createassignment"

@inject NavigationManager UriHelper

@using Objects
@using System.Text;

@inject IJSRuntime JS;

<h3>CreateAssignment</h3>
<br>

<Popup @ref="popupRef" />

@foreach (AssignmentQuestion Q in questions)
{
    <p>Question @Q.ID</p>
    <div class="questionBox">

        <label for="">Question</label>
        <input type="text" @bind="Q.question" placeholder="@Q.question" required /> <br><br>

        <label for="radioBtn">
            <input type="radio" id="radioBtn" name="@Q.ID" value="radio"/>
            radio
        </label>
        <label for="checkboxBtn">
            <input type="radio" id="checkboxBtn" name="@Q.ID" value="checkbox" />
            checkbox
        </label>
        <label for="textBtn">
            <input type="radio" id="textBtn" name="@Q.ID" value="text" />
            text
        </label><br><br>

        <label for="">Options</label>
        <input type="text" @bind="Q.StringOptions" placeholder="@Q.StringOptions" required /> <br><br>

        <label for="">Answer</label>
        <input type="text" @bind="Q.StringAnswers" placeholder="@Q.StringAnswers" required /> <br><br>

        <label for="">Points</label>
        <input type="text" @bind="Q.StringPoints" placeholder="@Q.StringPoints" required /><br> <br>

        <label for="">Distribution</label><br>
        <div class="questionBox">
            @foreach (string[] s in Q.skills)
            {
                <div class="skillBox">

                    <select name="Files" id="Files" @bind="s[0]">
                        <option disabled selected value> -- select an option -- </option>
                        @foreach (string file in File.ReadAllLines(GenFolderPath + "User Skills.txt"))
                        {
                            <option>@file</option>
                        }
                    </select>

                    <input type="text" @bind="s[1]" placeholder="XP" required /> <br>

                    <button @onclick="() => deleteSkill(s,Q)" style="float: right">Delete Skill</button><br>
                </div>

            }
            <button @onclick="() => addSkill(Q)" style="float: right">Add Skill</button><br>
        </div>

    </div>
    <br>
}

<button @onclick="add" style="float: right">add question</button><br><br>

<label for="">Due date</label>
<input type="date" @bind="Due" id="start" name="trip-start" min="2000-01-01" max="2099-12-31"><br><br>

<label for="">Assignment name</label>
<input type="text" @bind-value="Name" placeholder="Assignment name" /><br><br>

<button @onclick="done" style="float: left">done</button>

<button @onclick="back" style="float: left">back</button><br><br>

@code {

    private string GenFolderPath = Directory.GetCurrentDirectory() + @"\UserRecords\General\";
    private List<AssignmentQuestion> questions = new List<AssignmentQuestion>();
    private List<string[]> skills = new List<string[]>();
    private string Name, FileDesPath, questionType;
    private DateTime Due;
    int QuestionCount = 1;

    protected override void OnInitialized()
    {
        add();
    }

    public void add()
    {
        AssignmentQuestion Q = new AssignmentQuestion();
        Q.ID = QuestionCount+"";
        QuestionCount++;
        string[] hold = { "", "" };
        Q.skills.Add(hold);
        questions.Add(Q);
    }

    public void deleteSkill(String[] s, AssignmentQuestion Q)
    {
        Q.skills.Remove(s);
    }

    public void addSkill(AssignmentQuestion Q)
    {
        string[] hold = { "", "" };
        Q.skills.Add(hold);
    }

    public async void done()
    {
        if (Name == null)
        {
            Alert("Need to give assignment a name");
            return;
        }
        else if(Due == null)
        {
            Alert("Need to give assignment a due date");
            return;
        }

        FileDesPath = Directory.GetCurrentDirectory() + @"\AssignmentFolder\" + Name;

        FileStream FileWrite = new FileStream(FileDesPath, FileMode.Create, FileAccess.Write, FileShare.None);

        string AssignmentInfo = "DUE|\n" + Due +"\n";

        foreach(AssignmentQuestion Q in questions)
        {
            questionType = await JS.InvokeAsync<string>("RadioButtons", Q.ID);

            AssignmentInfo += "questions|\n" + Q.question + "\n";

            AssignmentInfo += "type|\n" + questionType.Replace(";","") + "\n";

            AssignmentInfo += "options|\n" + Q.StringOptions.Replace(" ", ";").Substring(0, Q.StringOptions.Replace(" ", ";").Length) + "\n";

            AssignmentInfo += "answer|\n" + Q.StringAnswers.Replace(" ", ";") + "\n";

            AssignmentInfo += "Points|\n" + Q.StringPoints+ "\n";

            AssignmentInfo += "DISTRIBUTION|\n";
            foreach(string[] s in Q.skills)
            {
                AssignmentInfo += s[0] + ";" + s[1] + ";\n";
            }

            AssignmentInfo += "end|\n";
        }

        // Store the text in a byte array with. UTF8 encoding (8-bit Unicode. Transformation Format)
        byte[] writeArr = Encoding.UTF8.GetBytes(AssignmentInfo);

        // Using the Write method write the encoded byte array to the textfile
        FileWrite.Write(writeArr, 0, AssignmentInfo.Length);

        // Closee the FileStream object
        FileWrite.Close();

        UriHelper.NavigateTo($"assignments");
    }

    public void back()
    {
        UriHelper.NavigateTo($"assignments");
    }

    private Popup popupRef;
    public async Task Alert(string message)
    {
        popupRef.Show(message);
    }
}
