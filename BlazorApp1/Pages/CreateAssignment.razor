@page "/createassignment"

@inject NavigationManager UriHelper

@using Objects
@using System.Text;

@inject IJSRuntime JS;

<head>
<script suppress-error="BL9992">
   function ShowHideDiv(){
        var fileCheck = document.getElementById("fileBtn");
        var dvFile = document.getElementById("dvFile");
        dvFile.style.display = fileCheck.checked ? "block" : "none";
   }
</script>

<script suppress-error="BL9992" src="JSFolder/upload.js"></script>

</head>

<h3>Create Assignment</h3>
<br>

<Popup @ref="popupRef" />



@foreach (AssignmentQuestion Q in questions)
{
    <p>Question @Q.ID</p>
    <div class="questionBox">

        Question:
        <input type="text" @bind="Q.question" placeholder="@Q.question" required /> <br><br>
        Question Type:
        <label for="radioBtn">
            <input type="radio" id="radioBtn" name="@Q.ID" value="radio" onclick="ShowHideDiv()"/>
            Single choice
        </label>
        <label for="checkboxBtn">
            <input type="radio" id="checkboxBtn" name="@Q.ID" value="checkbox" onclick="ShowHideDiv()" />
            Multiple choice
        </label>
        <label for="textBtn">
            <input type="radio" id="textBtn" name="@Q.ID" value="text" onclick="ShowHideDiv()" />
            Text field
        </label>

        <label for="fileBtn">
            <input type="radio" id="fileBtn" name="@Q.ID" value="file" onclick="ShowHideDiv()" />
            File
        </label><br><br>
        
        <script suppress-error="BL9992" src="JSFolder\upload.js"></script>
        <div id="dvFile" style="display: none">
            <br>
        
          <div class="file-upload">
              
                <input class="file-upload__input" type="file" name="myFile[]" id="myFile" multiple>
                <button class="file-upload__button" type="button">Choose File(s)</button>
                <span class="file-upload__label"></span>
            </div>

           
                <br> <br>
        </div>
        

        Options: 
        <input type="text" @bind="Q.StringOptions" placeholder="@Q.StringOptions" required /> <br><br>

        Correct Answer:
        <input type="text" @bind="Q.StringAnswers" placeholder="@Q.StringAnswers" required /> <br><br>

        Points:
        <input type="text" @bind="Q.StringPoints" placeholder="@Q.StringPoints" required /><br> <br>


        <label for="">Skill earned</label><br>
        <div class="questionBox">
            @foreach (string[] s in Q.skills)
            {
                <div class="skillBox">

                    <select name="Files" id="Files" @bind="s[0]">
                        <option disabled selected value> -- select an option -- </option>
                        @foreach (string file in File.ReadAllLines(GenFolderPath + "User Skills.txt"))
                        {
                            <option>@file</option>
                        }
                    </select>

                    <input type="text" @bind="s[1]" placeholder="XP" required /> <br>

                    <button @onclick="() => deleteSkill(s,Q)" style="float: right">Delete Skill</button><br>
                </div>

            }
            <button @onclick="() => addSkill(Q)" style="float: right">Add Skill</button><br>
        </div>

    </div>
    <br>
}

<button @onclick="add" style="float: right">add question</button><br><br>

<label for="">Due date</label>
<input type="date" @bind="Due" id="start" name="trip-start" min=@currentDate max="2099-12-31">
<br><br>

<label for="">Assignment name</label>
<input type="text" @bind-value="Name" placeholder="Assignment name" /><br><br>

<button @onclick="done" style="float: left">done</button>

<button @onclick="back" style="float: left">back</button><br><br>


@code {

    private string GenFolderPath = Directory.GetCurrentDirectory() + @"\UserRecords\General\";
    private List<AssignmentQuestion> questions = new List<AssignmentQuestion>();
    private List<string[]> skills = new List<string[]>();
    private string Name, FileDesPath, questionType;
    private DateTime Due;
    private DateTime Today = DateTime.Today;
    private string currentDate;
    int QuestionCount = 1;

    protected override void OnInitialized()
    {
        currentDate = Today.ToString("yyyy-MM-dd");
        add();
    }

    public void add()
    {
        AssignmentQuestion Q = new AssignmentQuestion();
        Q.ID = QuestionCount+"";
        QuestionCount++;
        string[] hold = { "", "" };
        Q.skills.Add(hold);
        questions.Add(Q);
    }

    public void deleteSkill(String[] s, AssignmentQuestion Q)
    {
        Q.skills.Remove(s);
    }

    public void addSkill(AssignmentQuestion Q)
    {
        string[] hold = { "", "" };
        Q.skills.Add(hold);
    }

    public async void done()
    {
        if (Name == null)
        {
            Alert("Need to give assignment a name");
            return;
        }
        else if(Due == null)
        {
            Alert("Need to give assignment a due date");
            return;
        }

        FileDesPath = Directory.GetCurrentDirectory() + @"\AssignmentFolder\" + Name;

        FileStream FileWrite = new FileStream(FileDesPath, FileMode.Create, FileAccess.Write, FileShare.None);

        string AssignmentInfo = "DUE|\n" + Due +"\n";

        foreach(AssignmentQuestion Q in questions)
        {
            questionType = await JS.InvokeAsync<string>("RadioButtons", Q.ID);

            AssignmentInfo += "questions|\n" + Q.question + "\n";

            AssignmentInfo += "type|\n" + questionType.Replace(";","") + "\n";

            AssignmentInfo += "options|\n" + Q.StringOptions.Replace(" ", ";").Substring(0, Q.StringOptions.Replace(" ", ";").Length) + "\n";

            AssignmentInfo += "answer|\n" + Q.StringAnswers.Replace(" ", ";") + "\n";

            AssignmentInfo += "Points|\n" + Q.StringPoints+ "\n";

            AssignmentInfo += "DISTRIBUTION|\n";
            foreach(string[] s in Q.skills)
            {
                AssignmentInfo += s[0] + ";" + s[1] + ";\n";
            }

            AssignmentInfo += "end|\n";
        }

        // Store the text in a byte array with. UTF8 encoding (8-bit Unicode. Transformation Format)
        byte[] writeArr = Encoding.UTF8.GetBytes(AssignmentInfo);

        // Using the Write method write the encoded byte array to the textfile
        FileWrite.Write(writeArr, 0, AssignmentInfo.Length);

        // Closee the FileStream object
        FileWrite.Close();

        UriHelper.NavigateTo($"assignments");
    }

    public void back()
    {
        UriHelper.NavigateTo($"assignments");
    }

    private Popup popupRef;
    public async Task Alert(string message)
    {
        popupRef.Show(message);
    }
}

<style>

    .file-upload {
        display: inline-flex;
        align-items: center;
        font-size: 15px;
    }

    .file-upload__input {
        display: none;
    }

    .file-upload__button {
        -webkit-appearance: none;
        background: blue;
        border: 2px solid blue;
        border-radius: 4px;
        outline: none;
        padding: 0.5em 0.8em;
        margin-right: 15px;
        color: #ffffff;
        font-size: 1em;
        font-family: "Quicksand", sans-serif;
        font-weight: bold;
        cursor: pointer;
    }

        .file-upload__button:active {
            background: blue;
        }

    .file-upload__label {
        max-width: 250px;
        font-size: 0.95em;
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
        font-family: "Quicksand", sans-serif;
    }
</style>